<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Lightning Out 2.0 - Vercel Deployed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 24px;
        }

        .container {
            max-width: 880px;
            margin: 0 auto;
        }

        .status {
            margin: 12px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .error {
            color: #b00020;
        }

        .ok {
            color: #006400;
        }

        pre {
            background: #f7f7f7;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
        }

        #mount {
            border: 1px dashed #999;
            min-height: 120px;
            padding: 16px;
            margin-top: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Lightning Out 2.0 with Aura Bridge (Vercel Deployed)</h1>
        <p>This page mounts the Aura wrapper that nests your LWC via Lightning Out. It expects a backend to inject a
            valid Salesforce session via OAuth.</p>

        <div id="status" class="status">Initializing…</div>

        <div>
            <button id="loginBtn">1) OAuth Login to Salesforce</button>
            <button id="mountBtn" disabled>2) Mount Component</button>
        </div>

        <h3>Mount Target</h3>
        <div id="mount">Component will render here…</div>

        <h3>Diagnostics</h3>
        <pre id="log"></pre>
    </div>

    <!-- Load Lightning Out bootstrap from your Salesforce domain.
       This can be your My Domain on the core instance or the instance URL returned with the token.
       We dynamically inject the script after obtaining org info from the backend. -->
    <script>
        (function () {
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const loginBtn = document.getElementById('loginBtn');
            const mountBtn = document.getElementById('mountBtn');
            const mountDivId = 'mount';

            let sessionId = null;
            let instanceUrl = null; // e.g. https://your-domain.my.salesforce.com

            function log(msg, isError) {
                const line = (new Date()).toISOString() + ' - ' + msg + '\n';
                logEl.textContent += line;
                if (isError) {
                    statusEl.classList.remove('ok');
                    statusEl.classList.add('error');
                    statusEl.textContent = msg;
                } else {
                    statusEl.classList.remove('error');
                    statusEl.classList.add('ok');
                    statusEl.textContent = msg;
                }
            }

            async function oauthLogin() {
                try {
                    log('Starting OAuth login…');
                    // Redirects to Salesforce login. The backend handles callback and stores tokens in server session.
                    window.location.href = '/auth/login';
                } catch (e) {
                    log('OAuth login failed: ' + (e && e.message ? e.message : e), true);
                }
            }

            async function fetchSession() {
                try {
                    const res = await fetch('/auth/session', { credentials: 'include' });
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    sessionId = data.sessionId;
                    instanceUrl = data.instanceUrl;
                    if (!sessionId || !instanceUrl) {
                        throw new Error('Missing sessionId or instanceUrl from server.');
                    }
                    log('Obtained session and instance URL.');
                    return true;
                } catch (e) {
                    log('Failed to retrieve session: ' + e.message, true);
                    return false;
                }
            }

            function loadLightningOutScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('Failed to load ' + src));
                    document.head.appendChild(script);
                });
            }

            async function ensureLightningOutLoaded() {
                if (window.$Lightning && typeof window.$Lightning.use === 'function') return true;
                if (!instanceUrl) throw new Error('Instance URL not available.');
                const loSrc = instanceUrl.replace(/\/$/, '') + '/lightning/lightning.out.js';
                log('Loading Lightning Out script from: ' + loSrc);
                await loadLightningOutScript(loSrc);
                if (!(window.$Lightning && typeof window.$Lightning.use === 'function')) {
                    throw new Error('Lightning Out failed to initialize.');
                }
                return true;
            }

            async function mountComponent() {
                try {
                    // 1) Ensure we have a valid session and org URL
                    if (!sessionId || !instanceUrl) {
                        const ok = await fetchSession();
                        if (!ok) return;
                    }

                    // 2) Load lightning.out.js
                    await ensureLightningOutLoaded();

                    // 3) Use your Lightning Out App and mount the Aura wrapper which wraps the LWC
                    const appName = 'c:LightningOutApp';
                    const componentName = 'c:HelloWorldAura';

                    log('Initializing $Lightning.use with app: ' + appName);

                    // Enhanced error handling for Lightning Out initialization
                    window.$Lightning.use(
                        appName,
                        function () {
                            log('Lightning Out app ready. Creating component: ' + componentName);
                            window.$Lightning.createComponent(
                                componentName,
                                // pass attributes to the Aura wrapper; it forwards to the LWC
                                { name: 'Vercel Deployed User' },
                                mountDivId,
                                function (cmp) {
                                    log('Component created successfully.');
                                }
                            );
                        },
                        instanceUrl,
                        sessionId,
                        function (error) {
                            log('Lightning Out initialization error: ' + (error && error.message ? error.message : error), true);
                        }
                    );
                } catch (e) {
                    log('Mount failed: ' + (e && e.message ? e.message : e), true);
                }
            }

            loginBtn.addEventListener('click', oauthLogin);
            mountBtn.addEventListener('click', mountComponent);

            // On load, check if a session already exists (e.g., after OAuth callback)
            (async function init() {
                statusEl.textContent = 'Checking for existing session…';
                try {
                    const has = await fetchSession();
                    if (has) {
                        statusEl.textContent = 'Session available. You can mount the component.';
                        mountBtn.disabled = false;
                    } else {
                        statusEl.textContent = 'No session. Click "OAuth Login to Salesforce".';
                        mountBtn.disabled = true;
                    }
                } catch (e) {
                    log('Init error: ' + e.message, true);
                }
            })();
        })();
    </script>
</body>

</html>